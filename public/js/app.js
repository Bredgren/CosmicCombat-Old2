// Generated by CoffeeScript 1.6.2
(function() {
  var Camera, Character, DebugDraw, Game, H, ParticleSystem, Planet, Universe, W, b2Collision, b2Common, b2Contacts, b2Controllers, b2Dynamics, b2Joints, b2Math, b2Shapes, b2Vec2, main, settings, stance,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  settings = {
    DEBUG: true,
    FULL_SCREEN: false,
    WIDTH: 900,
    HEIGHT: 600,
    PPM: 30,
    BOX2D_TIME_STEP: 1 / 60,
    BOX2D_VI: 10,
    BOX2D_PI: 10
  };

  b2Common = Box2D.Common;

  b2Math = Box2D.Common.Math;

  b2Vec2 = b2Math.b2Vec2;

  b2Collision = Box2D.Collision;

  b2Shapes = Box2D.Collision.Shapes;

  b2Dynamics = Box2D.Dynamics;

  b2Contacts = Box2D.Dynamics.Contacts;

  b2Controllers = Box2D.Dynamics.Controllers;

  b2Joints = Box2D.Dynamics.Joints;

  DebugDraw = (function(_super) {
    __extends(DebugDraw, _super);

    function DebugDraw(camera) {
      this.camera = camera;
      this._line_width = 1;
      this._alpha = 0.5;
      this._fill_alpha = 0.5;
      this._scale = 1.0;
      this.m_sprite = {
        graphics: {
          clear: function() {}
        }
      };
    }

    DebugDraw.prototype.SetSprite = function(_graphics) {
      this._graphics = _graphics;
    };

    DebugDraw.prototype.GetSprite = function() {
      return this._graphics;
    };

    DebugDraw.prototype.DrawCircle = function(center, radius, color) {
      this._graphics.alpha = this._alpha;
      this._graphics.lineStyle(this._line_width, color.color);
      center = this.camera.worldToScreen({
        x: center.x * this._scale,
        y: center.y * this._scale
      });
      return this._graphics.drawCircle(center.x, center.y, radius * this._scale);
    };

    DebugDraw.prototype.DrawPolygon = function(vertices, vertexCount, color) {
      var v, v0, _i, _len, _ref;

      this._graphics.lineStyle(this._line_width, color.color);
      this._graphics.alpha = this._alpha;
      v0 = vertices[0];
      v0 = this.camera.worldToScreen({
        x: v0.x * this._scale,
        y: v0.y * this._scale
      });
      this._graphics.moveTo(v0.x, v0.y);
      _ref = vertices.slice(1);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        v = _ref[_i];
        v = this.camera.worldToScreen({
          x: v.x * this._scale,
          y: v.y * this._scale
        });
        this._graphics.lineTo(v.x, v.y);
      }
      return this._graphics.lineTo(v0.x, v0.y);
    };

    DebugDraw.prototype.DrawSegment = function(p1, p2, color) {
      this._graphics.lineStyle(this._line_width, color.color);
      this._graphics.alpha = this._alpha;
      p1 = this.camera.worldToScreen({
        x: p1.x * this._scale,
        y: p1.y * this._scale
      });
      p2 = this.camera.worldToScreen({
        x: p2.x * this._scale,
        y: p2.y * this._scale
      });
      this._graphics.moveTo(p1.x, p1.y);
      return this._graphics.lineTo(p2.x, p2.y);
    };

    DebugDraw.prototype.DrawSolidCircle = function(center, radius, axis, color) {
      var edge;

      this._graphics.beginFill(color.color);
      this._graphics.fillAlpha = this._fill_alpha;
      this.DrawCircle(center, radius, color);
      this._graphics.endFill();
      axis.Normalize();
      axis.Multiply(radius);
      edge = center.Copy();
      edge.Add(axis);
      return this.DrawSegment(center, edge, color);
    };

    DebugDraw.prototype.DrawSolidPolygon = function(vertices, vertexCount, color) {
      this._graphics.beginFill(color.color);
      this._graphics.fillAlpha = this._fill_alpha;
      this.DrawPolygon(vertices, vertexCount, color);
      return this._graphics.endFill();
    };

    DebugDraw.prototype.GetAlpha = function() {
      return this._alpha;
    };

    DebugDraw.prototype.GetDrawScale = function() {
      return this._scale;
    };

    DebugDraw.prototype.GetFillAlpha = function() {
      return this._fill_alpha;
    };

    DebugDraw.prototype.GetLineThickness = function() {
      return this._line_width;
    };

    DebugDraw.prototype.SetAlpha = function(_alpha) {
      this._alpha = _alpha;
    };

    DebugDraw.prototype.SetDrawScale = function(_scale) {
      this._scale = _scale;
    };

    DebugDraw.prototype.SetLineThickness = function(_line_width) {
      this._line_width = _line_width;
    };

    return DebugDraw;

  })(b2Dynamics.b2DebugDraw);

  Character = (function() {
    function Character(universe) {
      var bodyDef, fixDef;

      this.universe = universe;
      this.stand = PIXI.Sprite.fromFrame("jackie_stand_01");
      this.stand.anchor.x = .5;
      this.stand.anchor.y = .5;
      this.universe.game.stage.addChild(this.stand);
      bodyDef = new b2Dynamics.b2BodyDef();
      bodyDef.type = b2Dynamics.b2Body.b2_dynamicBody;
      bodyDef.position.x = -8;
      bodyDef.position.y = -10;
      fixDef = new b2Dynamics.b2FixtureDef();
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;
      fixDef.shape = new b2Shapes.b2PolygonShape();
      fixDef.shape.SetAsBox(.7, .8);
      this.body = this.universe._world.CreateBody(bodyDef);
      this.body.CreateFixture(fixDef);
    }

    Character.prototype.update = function() {
      var pos;

      pos = this.body.GetPosition();
      pos = {
        x: pos.x * settings.PPM,
        y: pos.y * settings.PPM
      };
      pos = this.universe.game.camera.worldToScreen(pos);
      this.stand.position.x = pos.x;
      return this.stand.position.y = pos.y;
    };

    Character.prototype.draw = function() {};

    return Character;

  })();

  Universe = (function() {
    Universe.prototype._planets = [];

    Universe.prototype._characters = [];

    Universe.prototype._world = null;

    Universe.prototype._debug_draw = settings.DEBUG;

    Universe.prototype._debug_drawer = null;

    Universe.prototype.controlled_char = null;

    function Universe(game, graphics, camera) {
      var bodyDef, character, doSleep, fixDef, gravity;

      this.game = game;
      this.graphics = graphics;
      this.camera = camera;
      gravity = new b2Vec2(0, 10);
      this._world = new b2Dynamics.b2World(gravity, doSleep = true);
      this._debug_drawer = new DebugDraw(this.camera);
      this._debug_drawer.SetSprite(this.graphics);
      this._debug_drawer.SetDrawScale(settings.PPM);
      this._debug_drawer.SetFillAlpha(0.3);
      this._debug_drawer.SetLineThickness(1.0);
      this._debug_drawer.SetFlags(b2Dynamics.b2DebugDraw.e_shapeBit | b2Dynamics.b2DebugDraw.e_jointBit);
      this._world.SetDebugDraw(this._debug_drawer);
      this._terrain = [];
      this._createTerrain();
      this._updateTerrainBody();
      bodyDef = new b2Dynamics.b2BodyDef();
      bodyDef.type = b2Dynamics.b2Body.b2_dynamicBody;
      bodyDef.position.x = 0;
      bodyDef.position.y = -10;
      fixDef = new b2Dynamics.b2FixtureDef();
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;
      fixDef.shape = new b2Shapes.b2CircleShape(1);
      this._world.CreateBody(bodyDef).CreateFixture(fixDef);
      character = new Character(this);
      this._characters.push(character);
      this.controlled_char = character;
    }

    Universe.prototype.update = function() {
      var c, _i, _len, _ref;

      _ref = this._characters;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        c = _ref[_i];
        c.update();
      }
      this._world.Step(settings.BOX2D_TIME_STEP, settings.BOX2D_VI, settings.BOX2D_PI);
      return this._world.ClearForces();
    };

    Universe.prototype.draw = function() {
      var c, _i, _len, _ref;

      _ref = this._characters;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        c = _ref[_i];
        c.draw();
      }
      if (this._debug_draw) {
        return this._world.DrawDebugData();
      }
    };

    Universe.prototype.toggleDebugDraw = function() {
      return this._debug_draw = !this._debug_draw;
    };

    Universe.prototype._createTerrain = function() {
      var cx, cy, h, w;

      w = 20 / 2;
      h = 10 / 2;
      cx = 0;
      cy = h;
      return this._terrain = [
        [
          {
            x: cx - w,
            y: cy - h
          }, {
            x: cx + w,
            y: cy - h
          }, {
            x: cx + w,
            y: cy + h
          }, {
            x: cx - w,
            y: cy + h
          }
        ]
      ];
    };

    Universe.prototype._updateTerrainBody = function() {
      var body, bodyDef, data, fixDef, poly, shape, v, _i, _j, _len, _len1, _ref, _results;

      body = this._world.GetBodyList();
      while (body) {
        data = body.GetUserData();
        if (data && data === "Terrain") {
          this._world.DestroyBody(body);
        }
        body = body.GetNext();
      }
      bodyDef = new b2Dynamics.b2BodyDef();
      bodyDef.type = b2Dynamics.b2Body.b2_staticBody;
      bodyDef.userData = "Terrain";
      fixDef = new b2Dynamics.b2FixtureDef();
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;
      _ref = this._terrain;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        poly = _ref[_i];
        fixDef.shape = new b2Shapes.b2PolygonShape();
        shape = [];
        for (_j = 0, _len1 = poly.length; _j < _len1; _j++) {
          v = poly[_j];
          shape.push(new b2Vec2(v.x, v.y));
        }
        fixDef.shape.SetAsArray(shape, shape.length);
        _results.push(this._world.CreateBody(bodyDef).CreateFixture(fixDef));
      }
      return _results;
    };

    return Universe;

  })();

  Camera = (function() {
    function Camera(x, y, w, h, zoom) {
      this.x = x;
      this.y = y;
      this.w = w;
      this.h = h;
      this.zoom = zoom != null ? zoom : 1.0;
    }

    Camera.prototype.worldToScreen = function(point) {
      return {
        x: point.x - this.x + this.w / 2,
        y: point.y - this.y + this.h / 2
      };
    };

    Camera.prototype.screenToWorld = function(point) {
      return {
        x: point.x + this.x - this.w / 2,
        y: point.y + this.y - this.h / 2
      };
    };

    return Camera;

  })();

  Game = (function() {
    Game.prototype._dev_mode = false;

    Game.prototype._universe = null;

    Game.prototype.camera = null;

    Game.prototype._last_mouse_pos = {
      x: 0,
      y: 0
    };

    Game.prototype._mouse_down = false;

    function Game(stage, graphics) {
      var style;

      this.stage = stage;
      this.graphics = graphics;
      this.camera = new Camera(0, 0, settings.WIDTH, settings.HEIGHT);
      this._universe = new Universe(this, this.graphics, this.camera);
      style = {
        font: "15px Arial",
        fill: "#FFFFFF"
      };
      this._dev_text = new PIXI.Text("Dev-Mode", style);
      this._dev_text.position.x = 10;
      this._dev_text.position.y = 5;
      this._dev_text.renderable = false;
      this.stage.addChild(this._dev_text);
    }

    Game.prototype.update = function() {
      return this._universe.update();
    };

    Game.prototype.draw = function() {
      return this._universe.draw();
    };

    Game.prototype.toggleDevMode = function() {
      if (this._dev_mode) {
        this.stage.addChild(this._dev_text);
      } else {
        this.stage.removeChild(this._dev_text);
      }
      return this._dev_mode = !this._dev_mode;
    };

    Game.prototype.toggleDebugDraw = function() {
      return this._universe.toggleDebugDraw();
    };

    Game.prototype.onKeyDown = function(key_code) {
      var loc;

      if (key_code === 65) {
        loc = this._universe.controlled_char.body.GetPosition();
        return this._universe.controlled_char.body.ApplyForce(new b2Vec2(-100, 0), loc);
      } else if (key_code === 68) {
        loc = this._universe.controlled_char.body.GetPosition();
        return this._universe.controlled_char.body.ApplyForce(new b2Vec2(100, 0), loc);
      }
    };

    Game.prototype.onKeyUp = function(key_code) {};

    Game.prototype.onMouseDown = function(screen_pos) {
      return this._mouse_down = true;
    };

    Game.prototype.onMouseUp = function(screen_pos) {
      return this._mouse_down = false;
    };

    Game.prototype.onMouseMove = function(screen_pos) {
      var dx, dy;

      if (this._mouse_down) {
        dx = screen_pos.x - this._last_mouse_pos.x;
        dy = screen_pos.y - this._last_mouse_pos.y;
        this.camera.x -= dx;
        this.camera.y -= dy;
      }
      return this._last_mouse_pos = screen_pos;
    };

    Game.prototype.onMouseWheel = function(delta) {};

    return Game;

  })();

  $(function() {
    var DOM_LOADED, assets, loader;

    DOM_LOADED = true;
    assets = ["assets/img/jackie_chun.json"];
    loader = new PIXI.AssetLoader(assets);
    loader.onComplete = main;
    return loader.load();
  });

  W = 0;

  H = 0;

  stance = null;

  main = function() {
    var black, blurHandler, body, canvas, clear, clickHandler, container, draw, event_catcher, focusHandler, game, graphics, keyDownListener, main_loop, mouseDownHandler, mouseMoveHandler, mouseOutHandler, mouseUpHandler, mouseWheelHandler, onBeforeUnload, onResize, queue, renderer, stage, t, update;

    W = settings.FULL_SCREEN ? window.innerWidth : settings.WIDTH;
    H = settings.FULL_SCREEN ? window.innerHeight : settings.HEIGHT;
    body = $('body');
    container = $('<div>');
    container.css('margin-right', 'auto');
    container.css('margin-left', 'auto');
    container.css('width', "" + W + "px");
    body.append(container);
    black = 0x000000;
    stage = new PIXI.Stage(black);
    renderer = PIXI.autoDetectRenderer(W, H);
    container.append(renderer.view);
    canvas = $('canvas')[0];
    graphics = new PIXI.Graphics();
    stage.addChild(graphics);
    game = new Game(stage, graphics);
    onResize = function() {
      return console.log("resize");
    };
    keyDownListener = function(e) {
      console.log("key down:", e.keyCode);
      if (e.keyCode === 192) {
        game.toggleDevMode();
        game.toggleDebugDraw();
      }
      return game.onKeyDown(e.keyCode);
    };
    onBeforeUnload = function(e) {
      return console.log("leaving");
    };
    mouseMoveHandler = function(e) {
      var x, y;

      x = e.clientX;
      y = e.clientY;
      console.log("mouse:", x, y);
      return game.onMouseMove({
        x: x,
        y: y
      });
    };
    clickHandler = function(e) {
      var x, y;

      x = e.clientX;
      y = e.clientY;
      return console.log("click:", x, y);
    };
    mouseDownHandler = function(e) {
      var x, y;

      console.log("mouse down");
      x = e.clientX;
      y = e.clientY;
      return game.onMouseDown({
        x: x,
        y: y
      });
    };
    mouseUpHandler = function(e) {
      var x, y;

      console.log("mouse up");
      x = e.clientX;
      y = e.clientY;
      return game.onMouseUp({
        x: x,
        y: y
      });
    };
    mouseOutHandler = function(e) {
      return console.log("mouse out");
    };
    mouseWheelHandler = function(e) {
      var delta;

      delta = Math.max(-1, Math.min(1, e.wheelDelta || -e.detail));
      return console.log("mouse wheel: ", delta);
    };
    focusHandler = function(e) {
      return console.log("focus");
    };
    blurHandler = function(e) {
      return console.log("blur");
    };
    event_catcher = canvas;
    window.onresize = onResize;
    document.body.addEventListener('keydown', keyDownListener, false);
    window.onbeforeunload = onBeforeUnload;
    event_catcher.addEventListener('mousemove', mouseMoveHandler, false);
    event_catcher.addEventListener('click', clickHandler, false);
    event_catcher.addEventListener('mousedown', mouseDownHandler, false);
    event_catcher.addEventListener('mouseup', mouseUpHandler, false);
    event_catcher.addEventListener('mouseout', mouseOutHandler, false);
    event_catcher.addEventListener('DOMMouseScroll', mouseWheelHandler, false);
    event_catcher.addEventListener('mousewheel', mouseWheelHandler, false);
    event_catcher.addEventListener('focus', focusHandler, false);
    event_catcher.addEventListener('blur', blurHandler, false);
    main_loop = function() {
      update();
      clear();
      draw();
      return queue();
    };
    update = function() {
      return game.update();
    };
    clear = function() {
      return graphics.clear();
    };
    draw = function() {
      game.draw();
      return renderer.render(stage);
    };
    queue = function() {
      return window.requestAnimationFrame(main_loop);
    };
    t = function() {
      var anim, i, stand, tex, texture, _i, _j;

      anim = [];
      tex = PIXI.Texture.fromFrame("jackie_stand_01");
      anim.push(tex);
      for (i = _i = 1; _i <= 5; i = ++_i) {
        texture = PIXI.Texture.fromFrame("jackie_stance_0" + i);
        anim.push(texture);
      }
      for (i = _j = 0; _j <= 4; i = ++_j) {
        texture = PIXI.Texture.fromFrame("jackie_stance_0" + (5 - i));
        anim.push(texture);
      }
      anim.push(tex);
      stand = PIXI.Sprite.fromFrame("jackie_stand_01");
      stand.position.x = 32;
      stand.position.y = 64;
      stage.addChild(stand);
      stance = new PIXI.MovieClip(anim);
      stance.position.x = 100;
      stance.position.y = 100;
      stance.anchor.x = 0;
      stance.anchor.y = 1;
      stance.animationSpeed = 0.2;
      stance.loop = false;
      stance.play();
      stage.addChild(stance);
      return main_loop();
    };
    return main_loop();
  };

  Planet = (function() {
    function Planet() {}

    return Planet;

  })();

  ParticleSystem = (function() {
    function ParticleSystem(max_particles, update_fn, draw_fn) {
      this.max_particles = max_particles;
      this.update_fn = update_fn;
      this.draw_fn = draw_fn;
      this.particles = [];
      this.emitters = [];
      this.fields = [];
    }

    ParticleSystem.prototype.update = function() {
      var e, p, _i, _j, _len, _len1, _ref, _ref1, _results;

      _ref = this.emitters;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        this._emit(e);
      }
      _ref1 = this.particles;
      _results = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        p = _ref1[_j];
        _results.push(this._updateParticle(p));
      }
      return _results;
    };

    ParticleSystem.prototype.draw = function() {
      var p, _i, _len, _ref, _results;

      _ref = this.particles;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        _results.push(this.draw_fn(p));
      }
      return _results;
    };

    ParticleSystem.prototype.addEmitter = function(emitter) {
      return this.emitters.push(emitter);
    };

    ParticleSystem.prototype.addField = function(field) {
      return this.fields.push(field);
    };

    ParticleSystem.prototype.removeEmitter = function(emitter) {
      return this.emitters = this.emitters.filter(function(e) {
        return e !== emitter;
      });
    };

    ParticleSystem.prototype.removeField = function(field) {
      return this.fields = this.fields.filter(function(f) {
        return f !== field;
      });
    };

    ParticleSystem.prototype._addParticle = function(particle) {
      if (this.particles.length < this.max_particles) {
        return this.particles.push(particle);
      }
    };

    ParticleSystem.prototype._emit = function(e) {
      var i, _i, _ref, _results;

      if (!e.active) {
        return;
      }
      _results = [];
      for (i = _i = 0, _ref = e.rate; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        _results.push(this._addParticle(e.particle_fn()));
      }
      return _results;
    };

    ParticleSystem.prototype._updateParticle = function(p) {
      var dir_x, dir_y, f, field_acl, force, _i, _len, _ref;

      field_acl = {
        x: 0,
        y: 0
      };
      _ref = this.fields;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        f = _ref[_i];
        dir_x = f.pos.x - p.pos.x;
        dir_y = f.pos.y - p.pos.y;
        force = f.strength / Math.pow(dir_x * dir_x + dir_y * dir_y, 1.5);
        field_acl.x += dir_x * force;
        field_acl.y += dir_y * force;
      }
      this.update_fn(p, field_acl);
      p.life--;
      if (p.life <= 0) {
        return this.particles = this.particles.filter(function(par) {
          return par !== p;
        });
      }
    };

    return ParticleSystem;

  })();

}).call(this);
